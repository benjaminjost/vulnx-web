"use client";

import { CVERecord } from "@/models/CVERecord";
import { ColumnDef } from "@tanstack/react-table";
import { ExternalLink } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";

export const columns: ColumnDef<CVERecord>[] = [
  {
    id: "select",
    header: ({ table }) => (
      <Checkbox
        checked={
          table.getIsAllPageRowsSelected() ||
          (table.getIsSomePageRowsSelected() && "indeterminate")
        }
        onCheckedChange={(value: boolean) => table.toggleAllPageRowsSelected(!!value)}
        aria-label="Select all"
      />
    ),
    cell: ({ row }) => (
      <Checkbox
        checked={row.getIsSelected()}
        onCheckedChange={(value: boolean) => row.toggleSelected(!!value)}
        aria-label="Select row"
        onClick={(e: React.MouseEvent) => e.stopPropagation()}
      />
    ),
    enableSorting: false,
    enableHiding: false,
    size: 30,
  },
  {
    accessorKey: "cveId",
    header: "CVE ID",
    enableSorting: true,
    size: 140,
    cell: ({ row }) => {
      const cveId = row.getValue("cveId") as string;
      if (!cveId) {
        return <div></div>;
      }
      return (
        <div className="flex items-center gap-1">
          <a
            href={`/${cveId}`}
            target="_blank"
            rel="noopener noreferrer"
            className="cve-id font-mono text-sm font-semibold text-primary hover:text-primary/80 hover:underline transition-colors flex items-center gap-1"
          >
            {cveId}
            <ExternalLink className="h-3 w-3" />
          </a>
        </div>
      );
    },
  },
  {
    accessorKey: "name",
    header: "Vulnerability",
    enableSorting: true,
    size: 320,
    cell: ({ row }) => {
      const name = row.original.name || row.original.product || "N/A";
      return <div className="font-medium text-foreground truncate max-w-xl">{name}</div>;
    },
  },
  {
    accessorKey: "score",
    header: "Score",
    enableSorting: true,
    size: 70,
    sortingFn: (rowA, rowB) => {
      const scoreA = Number.parseFloat(rowA.getValue("score"));
      const scoreB = Number.parseFloat(rowB.getValue("score"));
      return scoreA - scoreB;
    },
    cell: ({ row }) => {
      const score = Number.parseFloat(row.getValue("score"));

      return (
        <div className="text-sm text-foreground">
          <span className="font-semibold">{score.toFixed(1)}</span>
        </div>
      );
    },
  },
  {
    accessorKey: "severity",
    header: "Severity",
    enableSorting: true,
    size: 80,
    sortingFn: (rowA, rowB) => {
      const severityOrder: Record<string, number> = {
        critical: 4,
        high: 3,
        medium: 2,
        low: 1,
        unknown: 0,
      };
      const severityA = (rowA.getValue("severity") as string).toLowerCase();
      const severityB = (rowB.getValue("severity") as string).toLowerCase();
      return (severityOrder[severityA] || 0) - (severityOrder[severityB] || 0);
    },
    cell: ({ row }) => {
      const severity = row.getValue("severity") as string;
      const severityLower = severity.toLowerCase();

      let badgeColor = "bg-muted text-muted-foreground";

      if (severityLower === "critical") {
        badgeColor = "bg-status-critical text-status-critical-foreground";
      } else if (severityLower === "high") {
        badgeColor = "bg-status-high text-status-high-foreground";
      } else if (severityLower === "medium") {
        badgeColor = "bg-status-medium text-status-medium-foreground";
      } else if (severityLower === "low") {
        badgeColor = "bg-status-low text-status-low-foreground";
      }

      return (
        <span
          className={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${badgeColor}`}
        >
          {severity}
        </span>
      );
    },
  },
  {
    accessorKey: "ageInDays",
    header: "Age",
    enableSorting: true,
    size: 70,
    sortingFn: (rowA, rowB) => {
      const ageA = rowA.getValue("ageInDays") as number;
      const ageB = rowB.getValue("ageInDays") as number;
      return ageA - ageB;
    },
    cell: ({ row }) => {
      const age = row.getValue("ageInDays") as number;
      return (
        <div className="text-sm text-muted-foreground">
          {age}d
        </div>
      );
    },
  },
  {
    accessorKey: "hasPoC",
    header: "PoC",
    enableSorting: true,
    size: 70,
    sortingFn: (rowA, rowB) => {
      const pocA = rowA.getValue("hasPoC") as boolean;
      const pocB = rowB.getValue("hasPoC") as boolean;
      return (pocA ? 1 : 0) - (pocB ? 1 : 0);
    },
    cell: ({ row }) => {
      const hasPoC = row.getValue("hasPoC") as boolean;
      return (
        <div className="flex items-center">
          {hasPoC ? (
            <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-primary text-primary-foreground">
              Yes
            </span>
          ) : (
            <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-secondary text-muted-foreground">
              No
            </span>
          )}
        </div>
      );
    },
  },
];
