"use client";

import React from "react";
import {
  Bar,
  BarChart,
  CartesianGrid,
  Cell,
  Pie,
  PieChart,
  XAxis,
  YAxis,
} from "recharts";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  ChartConfig,
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
} from "@/components/ui/chart";
import { CVERecord } from "@/models/CVERecord";

type InsightsProps = {
  data: CVERecord[];
};

type SeverityKey = "critical" | "high" | "medium" | "low" | "unknown";

const severityChartConfig: ChartConfig = {
  critical: { label: "Critical", color: "var(--color-status-critical)" },
  high: { label: "High", color: "var(--color-status-high)" },
  medium: { label: "Medium", color: "var(--color-status-medium)" },
  low: { label: "Low", color: "var(--color-status-low)" },
  unknown: { label: "Unknown", color: "var(--color-muted)" },
};

const histogramConfig: ChartConfig = {
  count: { label: "CVEs", color: "var(--color-primary)" },
};

const severityOrder: SeverityKey[] = [
  "critical",
  "high",
  "medium",
  "low",
  "unknown",
];

const normalizeSeverity = (value: string): SeverityKey => {
  const normalized = value?.toLowerCase() ?? "";
  if (normalized.includes("crit")) return "critical";
  if (normalized.includes("high")) return "high";
  if (normalized.includes("med")) return "medium";
  if (normalized.includes("low")) return "low";
  return "unknown";
};

export function InsightsPanel({ data }: Readonly<InsightsProps>) {
  const {
    severityData,
    histogramData,
    stats,
    totalWithScores,
    totalPoC,
    totalPatched,
    topVendors,
    topProducts,
  } = React.useMemo(() => {
    const severityCounts: Record<SeverityKey, number> = {
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      unknown: 0,
    };

    const publicationBuckets: Record<string, number> = {};
    const vendorCounts: Record<string, number> = {};
    const productCounts: Record<string, number> = {};

    let scoreSum = 0;
    let scoreCount = 0;
    let freshCount = 0;
    let pocCount = 0;
    let patchedCount = 0;

    data.forEach((item) => {
      const severityKey = normalizeSeverity(item.severity);
      severityCounts[severityKey] += 1;

      const date = item.publishedAt || new Date();
      const year = date.getFullYear?.() || new Date().getFullYear();
      const month = date.getMonth?.() || 0;
      const quarter = Math.floor(month / 3) + 1;
      const period = `${year} Q${quarter}`;
      publicationBuckets[period] = (publicationBuckets[period] || 0) + 1;

      if (typeof item.score === "number" && item.score > 0) {
        scoreSum += item.score;
        scoreCount += 1;
      }

      if (typeof item.ageInDays === "number" && item.ageInDays <= 30) {
        freshCount += 1;
      }

      if (item.hasPoC) {
        pocCount += 1;
      }

      if (item.isPatchAvailable) {
        patchedCount += 1;
      }

      if (item.vendor) {
        vendorCounts[item.vendor] = (vendorCounts[item.vendor] || 0) + 1;
      }
      if (item.product) {
        productCounts[item.product] = (productCounts[item.product] || 0) + 1;
      }
    });

    const severityData = severityOrder.map((key) => ({
      key,
      label: severityChartConfig[key].label,
      value: severityCounts[key],
    }));

    const topVendors = Object.entries(vendorCounts)
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);

    const topProducts = Object.entries(productCounts)
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);

    const histogramData = Object.entries(publicationBuckets)
      .map(([period, count]) => ({ period, count }))
      .sort((a, b) => {
        const [yearA, quarterA] = a.period.split(" Q");
        const [yearB, quarterB] = b.period.split(" Q");
        return (
          Number(yearA) - Number(yearB) || Number(quarterA) - Number(quarterB)
        );
      });

    const avgScore = scoreCount > 0 ? scoreSum / scoreCount : null;

    return {
      severityData,
      histogramData,
      totalWithScores: scoreCount,
      totalPoC: pocCount,
      totalPatched: patchedCount,
      topVendors,
      topProducts,
      stats: {
        averageScore: avgScore,
        freshCount,
      },
    };
  }, [data]);

  return (
    <Card className="border-border">
      <CardHeader>
        <div className="flex items-start justify-between gap-4">
          <div>
            <CardTitle className="text-lg">Search Insights</CardTitle>
            <p className="text-sm text-muted-foreground">
              Snapshot of severity balance, publication trends, and other key
              metrics for this result set.
            </p>
          </div>
          <div className="rounded-md border border-primary/30 bg-primary/10 px-3 py-2 text-xs text-primary">
            {data.length} result{data.length === 1 ? "" : "s"} analyzed
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          <div className="rounded-lg border border-border bg-secondary/40 p-3">
            <p className="text-xs text-muted-foreground">Average CVSS</p>
            <p className="text-xl font-semibold text-foreground">
              {stats.averageScore === null
                ? "N/A"
                : stats.averageScore.toFixed(1)}
            </p>
            <p className="text-[11px] text-muted-foreground">
              Based on {totalWithScores} scored CVEs
            </p>
          </div>
          <div className="rounded-lg border border-border bg-secondary/40 p-3">
            <p className="text-xs text-muted-foreground">Fresh (â‰¤30 days)</p>
            <p className="text-xl font-semibold text-foreground">
              {stats.freshCount}
            </p>
            <p className="text-[11px] text-muted-foreground">
              {data.length
                ? ((stats.freshCount / data.length) * 100).toFixed(0)
                : 0}
              % of results
            </p>
          </div>
          <div className="rounded-lg border border-border bg-secondary/40 p-3">
            <p className="text-xs text-muted-foreground">PoC Available</p>
            <p className="text-xl font-semibold text-foreground">{totalPoC}</p>
            <p className="text-[11px] text-muted-foreground">
              {data.length ? ((totalPoC / data.length) * 100).toFixed(0) : 0}%
              coverage
            </p>
          </div>
          <div className="rounded-lg border border-border bg-secondary/40 p-3">
            <p className="text-xs text-muted-foreground">Patch Available</p>
            <p className="text-xl font-semibold text-foreground">
              {totalPatched}
            </p>
            <p className="text-[11px] text-muted-foreground">
              {data.length
                ? ((totalPatched / data.length) * 100).toFixed(0)
                : 0}
              % addressed
            </p>
          </div>
        </div>

        <div className="grid gap-4 lg:grid-cols-3">
          <Card className="lg:col-span-1 border-border">
            <CardHeader className="pb-2 pt-4 px-4">
              <CardTitle className="text-sm font-medium text-foreground">
                Severity mix
              </CardTitle>
              <p className="text-xs text-muted-foreground">
                Slice represents share of CVEs per severity.
              </p>
            </CardHeader>
            <CardContent className="space-y-3 px-4 pb-4">
              <ChartContainer
                config={severityChartConfig}
                className="min-h-[180px] w-full"
              >
                <PieChart>
                  <ChartTooltip
                    content={
                      <ChartTooltipContent
                        formatter={(value, name) => {
                          const total = severityData.reduce(
                            (sum, item) => sum + item.value,
                            0,
                          );
                          const percentage =
                            total > 0
                              ? ((Number(value) / total) * 100).toFixed(1)
                              : "0";
                          return [`${value} (${percentage}%)`, name];
                        }}
                      />
                    }
                  />
                  <Pie
                    data={severityData}
                    dataKey="value"
                    nameKey="label"
                    innerRadius={55}
                    outerRadius={85}
                    strokeWidth={0}
                  >
                    {severityData.map((entry) => (
                      <Cell
                        key={entry.key}
                        fill={`var(--color-${entry.key})`}
                      />
                    ))}
                  </Pie>
                </PieChart>
              </ChartContainer>
              <div className="space-y-2">
                {severityData.map((entry) => {
                  const total = severityData.reduce(
                    (sum, item) => sum + item.value,
                    0,
                  );
                  const percentage =
                    total > 0 ? ((entry.value / total) * 100).toFixed(1) : "0";
                  return (
                    <div
                      key={entry.key}
                      className="flex items-center justify-between text-xs"
                    >
                      <div className="flex items-center gap-2">
                        <div
                          className="w-3 h-3 rounded-sm"
                          style={{
                            backgroundColor: `var(--color-${entry.key})`,
                          }}
                        />
                        <span className="text-muted-foreground">
                          {entry.label}
                        </span>
                      </div>
                      <div className="flex items-center gap-2 font-medium">
                        <span>{entry.value}</span>
                        <span className="text-muted-foreground">
                          ({percentage}%)
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>

          <Card className="lg:col-span-2 border-border">
            <CardHeader className="pb-2 pt-4 px-4">
              <CardTitle className="text-sm font-medium text-foreground">
                Publication timeline
              </CardTitle>
              <p className="text-xs text-muted-foreground">
                Histogram of CVEs by published quarter for this query.
              </p>
            </CardHeader>
            <CardContent className="px-4 pb-4">
              <ChartContainer
                config={histogramConfig}
                className="min-h-[280px] w-full"
              >
                <BarChart
                  accessibilityLayer
                  data={histogramData}
                  margin={{ top: 4, bottom: 20 }}
                >
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis
                    dataKey="period"
                    tickLine={false}
                    axisLine={false}
                    tickMargin={8}
                    angle={-45}
                    textAnchor="end"
                    height={60}
                  />
                  <YAxis
                    allowDecimals={false}
                    tickLine={false}
                    axisLine={false}
                    tickMargin={6}
                  />
                  <ChartTooltip content={<ChartTooltipContent />} />
                  <Bar
                    dataKey="count"
                    fill="var(--color-count)"
                    radius={[6, 6, 0, 0]}
                  />
                </BarChart>
              </ChartContainer>
            </CardContent>
          </Card>
        </div>

        {(topVendors.length > 0 || topProducts.length > 0) && (
          <div className="grid gap-4 lg:grid-cols-2">
            <div className="rounded-lg border border-border bg-secondary/40 p-4">
              <div className="mb-3">
                <p className="text-sm font-medium text-foreground">
                  Top vendors
                </p>
                <p className="text-xs text-muted-foreground">
                  Vendors with the most CVEs in this result set.
                </p>
              </div>
              <div className="space-y-2">
                {topVendors.map((vendor, idx) => {
                  const max = topVendors[0]?.count || 1;
                  const pct = Math.round((vendor.count / max) * 100);
                  return (
                    <div
                      key={`${vendor.name}-${idx}`}
                      className="flex items-center justify-between gap-3"
                    >
                      <div className="flex-1">
                        <div className="flex items-center justify-between text-xs font-medium text-foreground">
                          <span className="truncate">{vendor.name}</span>
                          <span className="text-muted-foreground">
                            {vendor.count}
                          </span>
                        </div>
                        <div className="mt-1 h-2 rounded bg-secondary">
                          <div
                            className="h-full rounded bg-primary"
                            style={{ width: `${pct}%` }}
                          />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="rounded-lg border border-border bg-secondary/40 p-4">
              <div className="mb-3">
                <p className="text-sm font-medium text-foreground">
                  Top products
                </p>
                <p className="text-xs text-muted-foreground">
                  Products with the most CVEs in this result set.
                </p>
              </div>
              <div className="space-y-2">
                {topProducts.map((product, idx) => {
                  const max = topProducts[0]?.count || 1;
                  const pct = Math.round((product.count / max) * 100);
                  return (
                    <div
                      key={`${product.name}-${idx}`}
                      className="flex items-center justify-between gap-3"
                    >
                      <div className="flex-1">
                        <div className="flex items-center justify-between text-xs font-medium text-foreground">
                          <span className="truncate">{product.name}</span>
                          <span className="text-muted-foreground">
                            {product.count}
                          </span>
                        </div>
                        <div className="mt-1 h-2 rounded bg-secondary">
                          <div
                            className="h-full rounded bg-primary"
                            style={{ width: `${pct}%` }}
                          />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
